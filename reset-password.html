<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #f6f6f6;
            padding: 2em;
            max-width: 400px;
            margin: auto;
        }

        input,
        button {
            display: block;
            margin: 1em 0;
            width: 100%;
            padding: 0.8em;
            font-size: 1em;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>
    <h2>Reset Your Password</h2>
    <input type="password" id="new-password" placeholder="Enter new password" />
    <button onclick="resetPassword()">Set New Password</button>
    <div id="message"></div>
    <p>If the app doesn't open automatically, you can <a href="myapp://reset-success">return to the app</a>.</p>

    <script>
        const supabase = supabase.createClient(
            'https://hmhezcwgarmqyploktws.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtaGV6Y3dnYXJtcXlwbG9rdHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjE3OTcxOTksImV4cCI6MjAzNzM3MzE5OX0.pmVdf563yQj0VYw5AiCNz78b-2s6JxyhGZ2Ut6Ot2x4'
        );

        async function resetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const msgEl = document.getElementById('message');
            msgEl.textContent = '';

            const { error } = await supabase.auth.updateUser({ password: newPassword });

            if (error) {
                msgEl.textContent = error.message;
                msgEl.className = 'error';
            } else {
                msgEl.textContent = 'Password updated successfully!';
                msgEl.className = 'success';
                document.getElementById('new-password').value = '';
                setTimeout(() => {
                    window.location.href = 'satori://reset-success';
                }, 5000);
            }
        }

        window.addEventListener('load', async () => {
            const fragment = window.location.hash;
            if (fragment.includes('access_token')) {
                const params = new URLSearchParams(fragment.slice(1));
                const access_token = params.get('access_token');
                const refresh_token = params.get('refresh_token');

                await supabase.auth.setSession({ access_token, refresh_token });
            }
        });
    </script>
</body>

</html>